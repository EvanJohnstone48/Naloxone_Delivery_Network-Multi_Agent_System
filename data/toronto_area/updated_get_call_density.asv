% getCallDensity.m
% Estimate overdose-call "density" for a single grid square.
%
% Uses:
%   Call-weighted score:   D_c  = sum_i f_i * C_i
%   Area-adjusted density: rho_c = sum_i f_i * (C_i / A_i)
%
% where:
%   f_i = fraction of this square covered by neighbourhood i (0..1)
%   C_i = total calls in neighbourhood i
%   A_i = area of neighbourhood i in km^2

%% ---------------- Script folder -------------------------
scriptFolder = fileparts(mfilename('fullpath'));

%% ---------------- Load calls + names + IDs -------------------------
% CSV must contain columns:
%   Neighbourhood Number
%   Neighbourhood Name
%   Number of calls

csvPathCalls = fullfile(scriptFolder, "neighbourhood_name_num_call.csv");
callTable    = readtable(csvPathCalls);

callNums  = callTable.("NeighbourhoodNumber");                 % numeric ID
callNames = lower(strtrim(callTable.("NeighbourhoodName")));   % normalized name
callVals  = callTable.("NumberOfCalls");                      % call counts

% Mapping from number → neighbourhood name
idToCallName = containers.Map(callNums, callNames);

% Mapping from name → call count
callMap = containers.Map(callNames, callVals);

%% ---------------- Load area data -------------------------
csvPathAreas = fullfile(scriptFolder,'toronto_areas.csv');
areaTable    = readtable(csvPathAreas);

areaKeys = lower(strtrim(areaTable.name));
areaVals = areaTable.area_km2;

areaMap = containers.Map(areaKeys, areaVals);

%% ---------------- User input ----------------------------
n = input('How many neighbourhoods overlap this square? ');

callScore = 0;
densScore = 0;
missingArea = {};
totalPct = 0;     % <--- track total percentage coverage

for i = 1:n
    fprintf('\nNeighbourhood %d:\n', i);
    id  = input('  Neighbourhood number: ');
    pct = input('  Coverage of square (0–100): ');

    totalPct = totalPct + pct;     % <--- accumulate %

    f = pct / 100;

    %% Validate ID exists
    if ~isKey(idToCallName, id)
        fprintf('    (Neighbourhood number %d not found → skipping)\n', id);
        continue;
    end

    nameKey = idToCallName(id);
    fprintf('    → %s\n', nameKey);


    %% ---- Calls lookup ----
    if isKey(callMap, nameKey)
        C = callMap(nameKey);
        fprintf('Call Score: %d', C)
    else
        fprintf('    (No call data for "%s" → using C = 0)\n', nameKey);
        C = 0;
    end

    callScore = callScore + f * C;


    %% ---- Area lookup ----
    if isKey(areaMap, nameKey)
        A = areaMap(nameKey);
        densScore = densScore + f * (C / A);
    else
        missingArea{end+1} = nameKey; %#ok<AGROW>
    end
end

%% ---------------- Validate percentages sum to 100 --------------------

if abs(totalPct - 100) > 1e-6
    fprintf('\nERROR: Total coverage = %.1f%% (must add up to 100%%).\n', totalPct);
    fprintf('Please restart and enter correct percentages.\n\n');
    return;    % stop the script
end

%% ---------------- Output -------------------------------------------

fprintf('\n====================================\n');
fprintf('Call-weighted score:       %.2f\n', callScore);

if densScore > 0
    fprintf('Area-adjusted density:     %.4f calls/km^2\n', densScore);
else
    fprintf('Area-adjusted density:     not available (no matching areas)\n');
end

if ~isempty(missingArea)
    fprintf('\nMissing area data for:\n');
    disp(unique(missingArea)');
end

fprintf('====================================\n');
